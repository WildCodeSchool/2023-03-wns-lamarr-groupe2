name: Compile and push client and server images

on:
        push:
                branches: ["backendTests"]
        workflow_dispatch:

jobs:
        Run-backend-tests:
                runs-on: ubuntu-latest
                steps:
                        - name: Checkout code
                          uses: actions/checkout@v2

                        - name: Set up Node.js
                          uses: actions/setup-node@v2
                          with:
                                  node-version: "14"

                        - name: Run backend tests
                          run: |
                                  cd backend
                                  npm install
                                  npm run test

        build-client:
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@v2
                        - uses: docker/login-action@v1
                          with:
                                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                                  password: ${{ secrets.DOCKERHUB_TOKEN }}
                        - uses: docker/setup-buildx-action@v1
                        - uses: docker/build-push-action@v2
                          with:
                                  context: ./frontend
                                  file: ./frontend/Dockerfile
                                  push: true
                                  tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_CLIENT_IMAGE_NAME }}:latest

        build-server:
                runs-on: ubuntu-latest
                steps:
                        - name: Checkout code
                          uses: actions/checkout@v2
                        - name: Set up Node.js
                          uses: actions/setup-node@v2
                          with:
                                  node-version: "14"
                        - name: Login to Docker Hub
                          uses: docker/login-action@v1
                          with:
                                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                                  password: ${{ secrets.DOCKERHUB_TOKEN }}
                        - name: Set up Docker Buildx
                          uses: docker/setup-buildx-action@v1
                        - name: Build and push
                          uses: docker/build-push-action@v2
                          with:
                                  context: ./backend
                                  file: ./backend/Dockerfile
                                  push: true
                                  tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_SERVER_IMAGE_NAME }}:latest

        send_redeploy_webhook:
                needs:
                        - Run-backend-tests
                        - build-client
                        - build-server
                runs-on: ubuntu-latest
                steps:
                        - name: Checkout code
                          uses: actions/checkout@v2
                        - name: Send Webhook
                          env:
                                  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
                          run: |
                                  curl -X POST -H "Content-Type: application/json" -d '{
                                    "repository": "${{ github.repository }}",
                                    "ref": "${{ github.ref }}",
                                    "commits": ${{ toJson(github.event.commits) }}
                                  }' $WEBHOOK_URL
